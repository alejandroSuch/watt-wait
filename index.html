<!DOCTYPE html>
<html lang="es" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f0f1a">
    <meta name="google-site-verification" content="BZp4WbYYJWp5VTPCks32eOg-Cp3H-EfeJFGbOkronIc">
    <meta name="msvalidate.01" content="836FC04430B5F288483741EE7786D122">
    <meta name="description" content="Calculadora gratuita para saber cu√°nto tiempo necesita tu coche el√©ctrico para cargar. Configura bater√≠a, potencia del cargador y programa la hora de carga.">
    <meta name="keywords" content="calculadora carga coche el√©ctrico, EV charging calculator, tiempo carga bater√≠a, wallbox, cargador el√©ctrico, kWh, programar carga">
    <meta name="author" content="WattWait">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://alejandrosuch.github.io/watt-wait/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://alejandrosuch.github.io/watt-wait/">
    <meta property="og:title" content="WattWait - Calculadora de Carga para Coches El√©ctricos">
    <meta property="og:description" content="Calcula el tiempo de carga de tu coche el√©ctrico. Configura bater√≠a, potencia y programa cu√°ndo quieres tenerlo listo.">
    <meta property="og:image" content="https://alejandrosuch.github.io/watt-wait/icons/icon-512.png">
    <meta property="og:locale" content="es_ES">
    <meta property="og:locale:alternate" content="en_GB">
    <meta property="og:locale:alternate" content="fr_FR">
    <meta property="og:locale:alternate" content="it_IT">
    <meta property="og:locale:alternate" content="pt_PT">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="https://alejandrosuch.github.io/watt-wait/">
    <meta name="twitter:title" content="WattWait - Calculadora de Carga EV">
    <meta name="twitter:description" content="Calcula el tiempo de carga de tu coche el√©ctrico. Configura bater√≠a, potencia y programa cu√°ndo quieres tenerlo listo.">
    <meta name="twitter:image" content="https://alejandrosuch.github.io/watt-wait/icons/icon-512.png">

    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WattWait">
    <meta name="application-name" content="WattWait">
    <meta name="mobile-web-app-capable" content="yes">

    <title>WattWait - Calculadora de Carga EV | Tiempo de carga coche el√©ctrico</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png" type="image/png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "WattWait",
        "description": "Calculadora gratuita para saber cu√°nto tiempo necesita tu coche el√©ctrico para cargar",
        "url": "https://alejandrosuch.github.io/watt-wait/",
        "applicationCategory": "UtilitiesApplication",
        "operatingSystem": "Any",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "EUR"
        },
        "inLanguage": ["es", "en", "fr", "it", "pt"],
        "browserRequirements": "Requires JavaScript",
        "softwareVersion": "1.0",
        "screenshot": "https://alejandrosuch.github.io/watt-wait/icons/icon-512.png"
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f1a;
            --bg-card: #1a1a2e;
            --bg-input: #252542;
            --accent: #00d4aa;
            --accent-glow: rgba(0, 212, 170, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #8a8a9a;
            --warning: #ffaa00;
            --danger: #ff5555;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            padding: 16px;
            padding-bottom: env(safe-area-inset-bottom, 16px);
            touch-action: manipulation;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 20px 0 30px;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 20px var(--accent-glow));
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #00a8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tagline {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--text-muted), transparent);
        }

        .slider-group {
            margin-bottom: 24px;
        }

        .slider-group:last-child {
            margin-bottom: 0;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .slider-label {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .slider-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            min-width: 80px;
            text-align: right;
        }

        .slider-value span {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-muted);
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-input);
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 20px var(--accent-glow);
            transition: transform 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.15);
        }

        input[type="range"]::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .battery-visual {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
        }

        .battery-bar {
            flex: 1;
            height: 24px;
            background: var(--bg-input);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .battery-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s ease;
            position: relative;
        }

        .battery-current {
            background: linear-gradient(90deg, #ff5555, #ffaa00, #00d4aa);
            background-size: 300% 100%;
        }

        .battery-target {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(0, 212, 170, 0.2);
            border-right: 3px dashed var(--accent);
        }

        .battery-tip {
            width: 6px;
            height: 12px;
            background: var(--text-muted);
            border-radius: 0 3px 3px 0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .input-label {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: block;
        }

        .stepper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stepper-btn {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            border: none;
            background: var(--bg-input);
            color: var(--accent);
            font-size: 24px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stepper-btn:active {
            background: var(--accent);
            color: var(--bg-primary);
            transform: scale(0.95);
        }

        .stepper-input {
            flex: 1;
            text-align: center;
        }

        .stepper-input input {
            width: 100%;
            background: var(--bg-input);
            border: none;
            border-radius: 14px;
            padding: 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            outline: none;
        }

        .stepper-input input:focus {
            box-shadow: 0 0 0 2px var(--accent);
        }

        .presets-group {
            margin-top: 12px;
        }

        .presets-group + .presets-group {
            margin-top: 8px;
        }

        .presets-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            flex: 1;
            min-width: calc(25% - 6px);
            padding: 10px 8px;
            border-radius: 10px;
            border: 1px solid var(--bg-input);
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:active,
        .preset-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .efficiency-slider-row {
            background: var(--bg-input);
            border-radius: 12px;
            margin-top: 16px;
            padding: 12px 16px;
        }

        .efficiency-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .efficiency-slider-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }

        .efficiency-slider-value span {
            font-size: 14px;
            font-weight: 400;
        }

        .efficiency-slider-row input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-card);
            border-radius: 3px;
            outline: none;
        }

        .efficiency-slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .efficiency-slider-row input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .efficiency-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-input);
            border-radius: 12px;
            margin-top: 16px;
        }

        .efficiency-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .efficiency-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .efficiency-value input {
            width: 60px;
            background: var(--bg-card);
            border: none;
            border-radius: 8px;
            padding: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
            text-align: center;
            outline: none;
        }

        .efficiency-value input#electricityPrice {
            width: 85px;
        }

        .efficiency-value span {
            color: var(--text-muted);
        }

        .schedule-section {
            background: var(--bg-input);
            border-radius: 12px;
            margin-top: 12px;
            overflow: hidden;
        }

        .schedule-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
        }

        .schedule-title {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .schedule-options {
            display: none;
            padding: 0 16px 16px;
            gap: 12px;
            flex-direction: column;
            overflow: hidden;
        }

        .schedule-options.active {
            display: flex;
        }

        .schedule-mode {
            display: flex;
            gap: 8px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--bg-card);
            background: var(--bg-card);
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .mode-btn:not(.active):hover {
            border-color: var(--text-muted);
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-card);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-muted);
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle input:checked + .toggle-slider {
            background-color: rgba(0, 212, 170, 0.3);
        }

        .toggle input:checked + .toggle-slider:before {
            transform: translateX(20px);
            background-color: var(--accent);
        }

        .schedule-section input[type="time"] {
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-card);
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
            text-align: center;
            outline: none;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            min-height: 48px;
        }

        .schedule-section input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.5;
        }

        .schedule-section input[type="time"]::-webkit-date-and-time-value {
            text-align: center;
        }

        .result-card {
            background: linear-gradient(135deg, #1a2a3a 0%, #1a1a2e 100%);
            border: 1px solid rgba(0, 212, 170, 0.2);
            text-align: center;
            padding: 32px 24px;
        }

        .result-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .result-time {
            font-size: 48px;
            font-weight: 700;
            color: var(--accent);
            line-height: 1.1;
            text-shadow: 0 0 30px var(--accent-glow);
        }

        .result-time span {
            font-size: 20px;
            font-weight: 400;
            color: var(--text-secondary);
        }

        .result-eta {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--bg-input);
        }

        .result-eta-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .result-eta-time {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .result-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--bg-input);
        }

        .detail-item {
            text-align: center;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .warning-message {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid rgba(255, 170, 0, 0.3);
            border-radius: 12px;
            margin-top: 16px;
            font-size: 13px;
            color: var(--warning);
        }

        .warning-message.show {
            display: flex;
        }

        .share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-top: 20px;
            padding: 14px 20px;
            background: var(--bg-input);
            border: 1px solid var(--text-muted);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .share-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .share-btn:active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
            transform: scale(0.98);
        }

        .share-btn svg {
            flex-shrink: 0;
        }

        footer {
            text-align: center;
            padding: 24px 0;
            color: var(--text-muted);
            font-size: 12px;
        }

        footer a {
            color: var(--accent);
            text-decoration: none;
        }

        .lang-selector {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 100;
        }

        .lang-btn {
            background: var(--bg-card);
            border: 1px solid var(--bg-input);
            border-radius: 10px;
            padding: 8px 12px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .lang-btn:hover {
            border-color: var(--accent);
        }

        .lang-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--bg-card);
            border: 1px solid var(--bg-input);
            border-radius: 10px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s;
            z-index: 100;
            min-width: 140px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .lang-selector.open .lang-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .lang-option {
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.15s;
        }

        .lang-option:hover {
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .lang-option.active {
            color: var(--accent);
            background: rgba(0, 212, 170, 0.1);
        }

        .container {
            position: relative;
        }

        @media (min-width: 480px) {
            body {
                padding: 24px;
            }

            .card {
                padding: 28px;
            }
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #f0f2f5;
                --bg-card: #ffffff;
                --bg-input: #e8eaed;
                --text-primary: #1a1a2e;
                --text-secondary: #5a5a6a;
                --text-muted: #8a8a9a;
            }

            .result-card {
                background: linear-gradient(135deg, #e8f5f0 0%, #ffffff 100%);
            }

            input[type="range"] {
                background: #d0d2d5;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="lang-selector" id="langSelector">
            <button class="lang-btn" id="langBtn" aria-haspopup="listbox" aria-expanded="false" aria-label="Seleccionar idioma">
                <span id="currentLangFlag" aria-hidden="true">üá™üá∏</span>
                <span id="currentLangCode">ES</span>
            </button>
            <div class="lang-dropdown" id="langDropdown" role="listbox" aria-label="Idiomas disponibles">
                <div class="lang-option" data-lang="es" role="option" tabindex="0">üá™üá∏ Espa√±ol</div>
                <div class="lang-option" data-lang="en" role="option" tabindex="0">üá¨üáß English</div>
                <div class="lang-option" data-lang="fr" role="option" tabindex="0">üá´üá∑ Fran√ßais</div>
                <div class="lang-option" data-lang="it" role="option" tabindex="0">üáÆüáπ Italiano</div>
                <div class="lang-option" data-lang="pt" role="option" tabindex="0">üáµüáπ Portugu√™s</div>
            </div>
        </div>

        <header>
            <div class="logo">‚ö°</div>
            <h1>WattWait</h1>
            <p class="tagline" data-i18n="tagline">Calculadora de carga para tu EV</p>
        </header>

        <main>
        <div class="card">
            <div class="section-title" data-i18n="batteryLevel">Nivel de bater√≠a</div>

            <div class="slider-group">
                <div class="slider-header">
                    <label class="slider-label" for="currentCharge" data-i18n="currentCharge">Carga actual</label>
                    <span class="slider-value" id="currentValue" aria-live="polite">20<span>%</span></span>
                </div>
                <input type="range" id="currentCharge" min="0" max="100" value="20" aria-describedby="currentValue">
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <label class="slider-label" for="targetCharge" data-i18n="targetCharge">Carga deseada</label>
                    <span class="slider-value" id="targetValue" aria-live="polite">80<span>%</span></span>
                </div>
                <input type="range" id="targetCharge" min="0" max="100" value="80" aria-describedby="targetValue">
            </div>

            <div class="battery-visual" role="img" aria-label="Visualizaci√≥n del nivel de bater√≠a">
                <div class="battery-bar">
                    <div class="battery-target" id="batteryTarget"></div>
                    <div class="battery-fill battery-current" id="batteryFill"></div>
                </div>
                <div class="battery-tip"></div>
            </div>
        </div>

        <div class="card">
            <div class="section-title" data-i18n="settings">Configuraci√≥n</div>

            <div class="input-group">
                <label class="input-label" for="batteryCapacity" data-i18n="batteryCapacity">Capacidad de bater√≠a (kWh)</label>
                <div class="stepper" role="group" aria-label="Control de capacidad de bater√≠a">
                    <button class="stepper-btn" data-adjust="capacity" data-delta="-5" aria-label="Reducir 5 kWh">‚àí</button>
                    <div class="stepper-input">
                        <input type="number" id="batteryCapacity" value="50" min="10" max="200" step="1" aria-label="Capacidad de bater√≠a en kWh">
                    </div>
                    <button class="stepper-btn" data-adjust="capacity" data-delta="5" aria-label="Aumentar 5 kWh">+</button>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label" for="chargerPower" data-i18n="chargerPower">Potencia del cargador (kW)</label>
                <div class="stepper" role="group" aria-label="Control de potencia del cargador">
                    <button class="stepper-btn" data-adjust="power" data-delta="-0.5" aria-label="Reducir 0.5 kW">‚àí</button>
                    <div class="stepper-input">
                        <input type="number" id="chargerPower" value="3.7" min="1" max="350" step="0.1" aria-label="Potencia del cargador en kW">
                    </div>
                    <button class="stepper-btn" data-adjust="power" data-delta="0.5" aria-label="Aumentar 0.5 kW">+</button>
                </div>
                <div class="presets-group" role="group" aria-label="Presets de carga AC">
                    <div class="presets-label" id="ac-presets-label">AC</div>
                    <div class="presets" role="radiogroup" aria-labelledby="ac-presets-label">
                        <button class="preset-btn" data-power="2.3" aria-label="2.3 kW - Enchufe dom√©stico">2.3</button>
                        <button class="preset-btn active" data-power="3.7" aria-label="3.7 kW - Wallbox monof√°sico">3.7</button>
                        <button class="preset-btn" data-power="7.4" aria-label="7.4 kW - Wallbox monof√°sico">7.4</button>
                        <button class="preset-btn" data-power="11" aria-label="11 kW - Wallbox trif√°sico">11</button>
                        <button class="preset-btn" data-power="22" aria-label="22 kW - Wallbox trif√°sico">22</button>
                    </div>
                </div>
                <div class="presets-group" role="group" aria-label="Presets de carga DC">
                    <div class="presets-label" id="dc-presets-label">DC</div>
                    <div class="presets" role="radiogroup" aria-labelledby="dc-presets-label">
                        <button class="preset-btn" data-power="50" aria-label="50 kW - CCS/CHAdeMO b√°sico">50</button>
                        <button class="preset-btn" data-power="100" aria-label="100 kW - CCS est√°ndar">100</button>
                        <button class="preset-btn" data-power="150" aria-label="150 kW - CCS alta potencia">150</button>
                        <button class="preset-btn" data-power="250" aria-label="250 kW - Tesla Supercharger V3">250</button>
                        <button class="preset-btn" data-power="350" aria-label="350 kW - Ionity ultrarr√°pido">350</button>
                    </div>
                </div>
            </div>

            <div class="efficiency-slider-row">
                <div class="efficiency-slider-header">
                    <label class="efficiency-label" for="efficiency" data-i18n="efficiency">Eficiencia de carga</label>
                    <span class="efficiency-slider-value" id="efficiencyValue">90<span>%</span></span>
                </div>
                <input type="range" id="efficiency" min="50" max="100" value="90" aria-label="Eficiencia de carga en porcentaje">
            </div>

            <div class="efficiency-row">
                <label class="efficiency-label" for="electricityPrice" data-i18n="electricityPrice">Precio electricidad</label>
                <div class="efficiency-value">
                    <input type="number" id="electricityPrice" value="0.15" min="0" max="2" step="0.00001" aria-label="Precio de electricidad por kWh">
                    <span aria-hidden="true">‚Ç¨/kWh</span>
                </div>
            </div>

            <div class="schedule-section">
                <div class="schedule-header">
                    <label class="toggle" for="scheduleEnabled">
                        <input type="checkbox" id="scheduleEnabled" role="switch" aria-label="Activar programaci√≥n de carga">
                        <span class="toggle-slider" aria-hidden="true"></span>
                    </label>
                    <span class="schedule-title" id="schedule-title" data-i18n="scheduleCharging">Programar carga</span>
                </div>
                <div class="schedule-options" id="scheduleOptions" role="group" aria-labelledby="schedule-title">
                    <div class="schedule-mode" role="radiogroup" aria-label="Modo de programaci√≥n">
                        <button class="mode-btn active" data-mode="start" data-i18n="startAt" role="radio" aria-checked="true">Empezar a las</button>
                        <button class="mode-btn" data-mode="end" data-i18n="finishAt" role="radio" aria-checked="false">Terminar a las</button>
                    </div>
                    <input type="time" id="scheduleTime" value="07:00" aria-label="Hora programada">
                </div>
            </div>
        </div>

        <div class="card result-card" role="region" aria-label="Resultados del c√°lculo" aria-live="polite">
            <div class="result-label" id="result-time-label" data-i18n="estimatedTime">Tiempo estimado de carga</div>
            <div class="result-time" id="resultTime" aria-labelledby="result-time-label">4<span aria-hidden="true">h</span> 30<span aria-hidden="true">min</span></div>

            <div class="result-eta">
                <div class="result-eta-label" id="resultEtaLabel" data-i18n="readyAt">Carga completa a las</div>
                <div class="result-eta-time" id="resultEta" aria-labelledby="resultEtaLabel">14:30</div>
            </div>

            <div class="result-eta result-start" id="resultStartRow" style="display: none;">
                <div class="result-eta-label" id="resultStartLabel" data-i18n="startChargingAt">Empezar a cargar a las</div>
                <div class="result-eta-time" id="resultStart" aria-labelledby="resultStartLabel">--:--</div>
            </div>

            <div class="result-details">
                <div class="detail-item">
                    <div class="detail-value" id="energyNeeded" aria-describedby="energy-needed-label">30.0 kWh</div>
                    <div class="detail-label" id="energy-needed-label" data-i18n="energyNeeded">Energ√≠a necesaria</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value" id="energyFromGrid" aria-describedby="grid-consumption-label">33.3 kWh</div>
                    <div class="detail-label" id="grid-consumption-label" data-i18n="gridConsumption">Consumo de red</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value" id="chargeCost" aria-describedby="charge-cost-label">5.00 ‚Ç¨</div>
                    <div class="detail-label" id="charge-cost-label" data-i18n="chargeCost">Coste estimado</div>
                </div>
            </div>

            <div class="warning-message" id="warningMessage" role="alert">
                <span aria-hidden="true">‚ö†Ô∏è</span>
                <span id="warningText"></span>
            </div>

            <button class="share-btn" id="shareBtn" style="display: none;" aria-label="Compartir resultado">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
                <span data-i18n="share">Compartir</span>
            </button>
        </div>
        </main>

        <footer data-i18n="footer">
            Hecho con ‚ö° para conductores de EV
        </footer>
    </div>

    <script>
        // ==================== TRANSLATIONS ====================
        const translations = {
            es: {
                tagline: 'Calculadora de carga para tu EV',
                batteryLevel: 'Nivel de bater√≠a',
                currentCharge: 'Carga actual',
                targetCharge: 'Carga deseada',
                settings: 'Configuraci√≥n',
                batteryCapacity: 'Capacidad de bater√≠a (kWh)',
                chargerPower: 'Potencia del cargador (kW)',
                efficiency: 'Eficiencia de carga',
                scheduleCharging: 'Programar carga',
                startAt: 'Empezar a las',
                finishAt: 'Terminar a las',
                estimatedTime: 'Tiempo estimado de carga',
                readyAt: 'Carga completa a las',
                startChargingAt: 'Empezar a cargar a las',
                energyNeeded: 'Energ√≠a necesaria',
                gridConsumption: 'Consumo de red',
                electricityPrice: 'Precio electricidad',
                chargeCost: 'Coste estimado',
                footer: 'Hecho con ‚ö° para conductores de EV',
                warningAlreadyCharged: 'La carga actual ya es igual o superior a la deseada',
                warningLongCharge: 'La carga tardar√° m√°s de 12 horas. Considera un cargador m√°s potente.',
                warningDcCurve: 'Con carga DC, la velocidad baja significativamente por encima del 80%.',
                warningStartInPast: 'No es posible alcanzar el {target}% a esa hora. Si empiezas ahora, llegar√°s al {achievable}%.',
                nextDay: '+1 d√≠a',
                hours: 'h',
                minutes: 'min',
                share: 'Compartir',
                shareTitle: 'WattWait - Tiempo de carga',
                shareText: 'Mi coche el√©ctrico necesita {time} para cargar del {from}% al {to}% con un cargador de {power} kW.',
                // ARIA labels
                ariaSelectLang: 'Seleccionar idioma',
                ariaAvailableLangs: 'Idiomas disponibles',
                ariaBatteryVisual: 'Visualizaci√≥n del nivel de bater√≠a',
                ariaCapacityControl: 'Control de capacidad de bater√≠a',
                ariaPowerControl: 'Control de potencia del cargador',
                ariaReduceCapacity: 'Reducir 5 kWh',
                ariaIncreaseCapacity: 'Aumentar 5 kWh',
                ariaReducePower: 'Reducir 0.5 kW',
                ariaIncreasePower: 'Aumentar 0.5 kW',
                ariaAcPresets: 'Presets de carga AC',
                ariaDcPresets: 'Presets de carga DC',
                ariaScheduleToggle: 'Activar programaci√≥n de carga',
                ariaScheduleMode: 'Modo de programaci√≥n',
                ariaScheduleTime: 'Hora programada',
                ariaResults: 'Resultados del c√°lculo',
                ariaShare: 'Compartir resultado'
            },
            en: {
                tagline: 'Charging calculator for your EV',
                batteryLevel: 'Battery level',
                currentCharge: 'Current charge',
                targetCharge: 'Target charge',
                settings: 'Settings',
                batteryCapacity: 'Battery capacity (kWh)',
                chargerPower: 'Charger power (kW)',
                efficiency: 'Charging efficiency',
                scheduleCharging: 'Schedule charging',
                startAt: 'Start at',
                finishAt: 'Finish at',
                estimatedTime: 'Estimated charging time',
                readyAt: 'Fully charged at',
                startChargingAt: 'Start charging at',
                energyNeeded: 'Energy needed',
                gridConsumption: 'Grid consumption',
                electricityPrice: 'Electricity price',
                chargeCost: 'Estimated cost',
                footer: 'Made with ‚ö° for EV drivers',
                warningAlreadyCharged: 'Current charge is already equal or higher than target',
                warningLongCharge: 'Charging will take more than 12 hours. Consider a more powerful charger.',
                warningDcCurve: 'With DC charging, speed drops significantly above 80%.',
                warningStartInPast: 'Cannot reach {target}% by that time. Starting now, you\'ll reach {achievable}%.',
                nextDay: '+1 day',
                hours: 'h',
                minutes: 'min',
                share: 'Share',
                shareTitle: 'WattWait - Charging time',
                shareText: 'My EV needs {time} to charge from {from}% to {to}% with a {power} kW charger.',
                // ARIA labels
                ariaSelectLang: 'Select language',
                ariaAvailableLangs: 'Available languages',
                ariaBatteryVisual: 'Battery level visualization',
                ariaCapacityControl: 'Battery capacity control',
                ariaPowerControl: 'Charger power control',
                ariaReduceCapacity: 'Decrease 5 kWh',
                ariaIncreaseCapacity: 'Increase 5 kWh',
                ariaReducePower: 'Decrease 0.5 kW',
                ariaIncreasePower: 'Increase 0.5 kW',
                ariaAcPresets: 'AC charging presets',
                ariaDcPresets: 'DC charging presets',
                ariaScheduleToggle: 'Enable charging schedule',
                ariaScheduleMode: 'Scheduling mode',
                ariaScheduleTime: 'Scheduled time',
                ariaResults: 'Calculation results',
                ariaShare: 'Share result'
            },
            fr: {
                tagline: 'Calculateur de charge pour votre VE',
                batteryLevel: 'Niveau de batterie',
                currentCharge: 'Charge actuelle',
                targetCharge: 'Charge souhait√©e',
                settings: 'Configuration',
                batteryCapacity: 'Capacit√© de batterie (kWh)',
                chargerPower: 'Puissance du chargeur (kW)',
                efficiency: 'Efficacit√© de charge',
                scheduleCharging: 'Programmer la charge',
                startAt: 'Commencer √†',
                finishAt: 'Terminer √†',
                estimatedTime: 'Temps de charge estim√©',
                readyAt: 'Charge compl√®te √†',
                startChargingAt: 'Commencer √† charger √†',
                energyNeeded: '√ânergie n√©cessaire',
                gridConsumption: 'Consommation r√©seau',
                electricityPrice: 'Prix √©lectricit√©',
                chargeCost: 'Co√ªt estim√©',
                footer: 'Fait avec ‚ö° pour les conducteurs de VE',
                warningAlreadyCharged: 'La charge actuelle est d√©j√† √©gale ou sup√©rieure √† la cible',
                warningLongCharge: 'La charge prendra plus de 12 heures. Envisagez un chargeur plus puissant.',
                warningDcCurve: 'Avec la charge DC, la vitesse diminue significativement au-dessus de 80%.',
                warningStartInPast: 'Impossible d\'atteindre {target}% √† cette heure. En commen√ßant maintenant, vous atteindrez {achievable}%.',
                nextDay: '+1 jour',
                hours: 'h',
                minutes: 'min',
                share: 'Partager',
                shareTitle: 'WattWait - Temps de charge',
                shareText: 'Mon VE a besoin de {time} pour charger de {from}% √† {to}% avec un chargeur de {power} kW.',
                // ARIA labels
                ariaSelectLang: 'S√©lectionner la langue',
                ariaAvailableLangs: 'Langues disponibles',
                ariaBatteryVisual: 'Visualisation du niveau de batterie',
                ariaCapacityControl: 'Contr√¥le de capacit√© de batterie',
                ariaPowerControl: 'Contr√¥le de puissance du chargeur',
                ariaReduceCapacity: 'R√©duire 5 kWh',
                ariaIncreaseCapacity: 'Augmenter 5 kWh',
                ariaReducePower: 'R√©duire 0.5 kW',
                ariaIncreasePower: 'Augmenter 0.5 kW',
                ariaAcPresets: 'Pr√©r√©glages de charge AC',
                ariaDcPresets: 'Pr√©r√©glages de charge DC',
                ariaScheduleToggle: 'Activer la programmation de charge',
                ariaScheduleMode: 'Mode de programmation',
                ariaScheduleTime: 'Heure programm√©e',
                ariaResults: 'R√©sultats du calcul',
                ariaShare: 'Partager le r√©sultat'
            },
            it: {
                tagline: 'Calcolatore di ricarica per il tuo EV',
                batteryLevel: 'Livello batteria',
                currentCharge: 'Carica attuale',
                targetCharge: 'Carica desiderata',
                settings: 'Impostazioni',
                batteryCapacity: 'Capacit√† batteria (kWh)',
                chargerPower: 'Potenza caricatore (kW)',
                efficiency: 'Efficienza di ricarica',
                scheduleCharging: 'Programma ricarica',
                startAt: 'Inizia alle',
                finishAt: 'Termina alle',
                estimatedTime: 'Tempo di ricarica stimato',
                readyAt: 'Ricarica completa alle',
                startChargingAt: 'Iniziare a caricare alle',
                energyNeeded: 'Energia necessaria',
                gridConsumption: 'Consumo dalla rete',
                electricityPrice: 'Prezzo elettricit√†',
                chargeCost: 'Costo stimato',
                footer: 'Fatto con ‚ö° per i conducenti di EV',
                warningAlreadyCharged: 'La carica attuale √® gi√† uguale o superiore a quella desiderata',
                warningLongCharge: 'La ricarica richieder√† pi√π di 12 ore. Considera un caricatore pi√π potente.',
                warningDcCurve: 'Con la ricarica DC, la velocit√† diminuisce significativamente sopra l\'80%.',
                warningStartInPast: 'Impossibile raggiungere il {target}% a quell\'ora. Iniziando ora, raggiungerai il {achievable}%.',
                nextDay: '+1 giorno',
                hours: 'h',
                minutes: 'min',
                share: 'Condividi',
                shareTitle: 'WattWait - Tempo di ricarica',
                shareText: 'Il mio EV ha bisogno di {time} per caricare dal {from}% al {to}% con un caricatore da {power} kW.',
                // ARIA labels
                ariaSelectLang: 'Seleziona lingua',
                ariaAvailableLangs: 'Lingue disponibili',
                ariaBatteryVisual: 'Visualizzazione livello batteria',
                ariaCapacityControl: 'Controllo capacit√† batteria',
                ariaPowerControl: 'Controllo potenza caricatore',
                ariaReduceCapacity: 'Riduci 5 kWh',
                ariaIncreaseCapacity: 'Aumenta 5 kWh',
                ariaReducePower: 'Riduci 0.5 kW',
                ariaIncreasePower: 'Aumenta 0.5 kW',
                ariaAcPresets: 'Preset di ricarica AC',
                ariaDcPresets: 'Preset di ricarica DC',
                ariaScheduleToggle: 'Attiva programmazione ricarica',
                ariaScheduleMode: 'Modalit√† di programmazione',
                ariaScheduleTime: 'Orario programmato',
                ariaResults: 'Risultati del calcolo',
                ariaShare: 'Condividi risultato'
            },
            pt: {
                tagline: 'Calculadora de carregamento para seu VE',
                batteryLevel: 'N√≠vel da bateria',
                currentCharge: 'Carga atual',
                targetCharge: 'Carga desejada',
                settings: 'Configura√ß√£o',
                batteryCapacity: 'Capacidade da bateria (kWh)',
                chargerPower: 'Pot√™ncia do carregador (kW)',
                efficiency: 'Efici√™ncia de carga',
                scheduleCharging: 'Programar carregamento',
                startAt: 'Come√ßar √†s',
                finishAt: 'Terminar √†s',
                estimatedTime: 'Tempo estimado de carregamento',
                readyAt: 'Carga completa √†s',
                startChargingAt: 'Come√ßar a carregar √†s',
                energyNeeded: 'Energia necess√°ria',
                gridConsumption: 'Consumo da rede',
                electricityPrice: 'Pre√ßo eletricidade',
                chargeCost: 'Custo estimado',
                footer: 'Feito com ‚ö° para motoristas de VE',
                warningAlreadyCharged: 'A carga atual j√° √© igual ou superior √† desejada',
                warningLongCharge: 'O carregamento levar√° mais de 12 horas. Considere um carregador mais potente.',
                warningDcCurve: 'Com carregamento DC, a velocidade diminui significativamente acima de 80%.',
                warningStartInPast: 'N√£o √© poss√≠vel alcan√ßar {target}% nesse hor√°rio. Come√ßando agora, voc√™ chegar√° a {achievable}%.',
                nextDay: '+1 dia',
                hours: 'h',
                minutes: 'min',
                share: 'Compartilhar',
                shareTitle: 'WattWait - Tempo de carregamento',
                shareText: 'Meu VE precisa de {time} para carregar de {from}% a {to}% com um carregador de {power} kW.',
                // ARIA labels
                ariaSelectLang: 'Selecionar idioma',
                ariaAvailableLangs: 'Idiomas dispon√≠veis',
                ariaBatteryVisual: 'Visualiza√ß√£o do n√≠vel da bateria',
                ariaCapacityControl: 'Controle de capacidade da bateria',
                ariaPowerControl: 'Controle de pot√™ncia do carregador',
                ariaReduceCapacity: 'Reduzir 5 kWh',
                ariaIncreaseCapacity: 'Aumentar 5 kWh',
                ariaReducePower: 'Reduzir 0.5 kW',
                ariaIncreasePower: 'Aumentar 0.5 kW',
                ariaAcPresets: 'Presets de carregamento AC',
                ariaDcPresets: 'Presets de carregamento DC',
                ariaScheduleToggle: 'Ativar programa√ß√£o de carregamento',
                ariaScheduleMode: 'Modo de programa√ß√£o',
                ariaScheduleTime: 'Hor√°rio programado',
                ariaResults: 'Resultados do c√°lculo',
                ariaShare: 'Compartilhar resultado'
            }
        };

        const langMeta = {
            es: { flag: 'üá™üá∏', code: 'ES' },
            en: { flag: 'üá¨üáß', code: 'EN' },
            fr: { flag: 'üá´üá∑', code: 'FR' },
            it: { flag: 'üáÆüáπ', code: 'IT' },
            pt: { flag: 'üáµüáπ', code: 'PT' }
        };

        let currentLang = 'es';

        // ==================== CONSTANTS ====================
        const THRESHOLDS = {
            LONG_CHARGE_HOURS: 12,      // Warning for very long charge times
            DC_POWER_MIN: 50,           // Minimum power to be considered DC charging
            DC_CURVE_TARGET: 80         // Above this %, DC charging slows significantly
        };

        // ==================== UTILITIES ====================
        // Debounce - delays execution until calls stop
        function debounce(fn, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // Throttle - limits execution rate
        function throttle(fn, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    fn.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // ==================== STORAGE ====================
        const STORAGE_KEY = 'wattwait_settings';

        const DEFAULTS = {
            currentCharge: 20,
            targetCharge: 80,
            batteryCapacity: 50,
            chargerPower: 3.7,
            efficiency: 90,
            electricityPrice: 0.15,
            scheduleEnabled: false,
            scheduleMode: 'end', // 'start' or 'end'
            scheduleTime: '07:00',
            lang: null // null = auto-detect
        };

        function loadSettings() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    return { ...DEFAULTS, ...JSON.parse(saved) };
                }
            } catch (e) {
                console.warn('Error loading settings:', e);
            }
            return DEFAULTS;
        }

        function saveSettingsNow() {
            try {
                const settings = {
                    currentCharge: parseInt(currentChargeSlider.value),
                    targetCharge: parseInt(targetChargeSlider.value),
                    batteryCapacity: parseFloat(batteryCapacityInput.value),
                    chargerPower: parseFloat(chargerPowerInput.value),
                    efficiency: parseInt(efficiencyInput.value),
                    electricityPrice: parseFloat(electricityPriceInput.value),
                    scheduleEnabled: scheduleEnabledInput.checked,
                    scheduleMode: currentScheduleMode,
                    scheduleTime: scheduleTimeInput.value,
                    lang: currentLang
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            } catch (e) {
                console.warn('Error saving settings:', e);
            }
        }

        // Throttled version - max once per 500ms
        const saveSettings = throttle(saveSettingsNow, 500);

        // ==================== i18n ====================
        function detectBrowserLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            const shortLang = browserLang.split('-')[0].toLowerCase();
            return translations[shortLang] ? shortLang : 'en';
        }

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            htmlRoot.setAttribute('lang', lang);

            // Update all translatable elements (cached)
            translatableElements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });

            // Update language selector button
            currentLangFlag.textContent = langMeta[lang].flag;
            currentLangCode.textContent = langMeta[lang].code;

            // Update active state in dropdown
            langOptions.forEach(opt => {
                opt.classList.toggle('active', opt.dataset.lang === lang);
            });

            // Update ARIA labels (using cached elements)
            langBtn.setAttribute('aria-label', t.ariaSelectLang);
            langDropdown.setAttribute('aria-label', t.ariaAvailableLangs);
            batteryVisual.setAttribute('aria-label', t.ariaBatteryVisual);
            if (steppers[0]) steppers[0].setAttribute('aria-label', t.ariaCapacityControl);
            if (steppers[1]) steppers[1].setAttribute('aria-label', t.ariaPowerControl);
            scheduleEnabledInput.setAttribute('aria-label', t.ariaScheduleToggle);
            scheduleMode.setAttribute('aria-label', t.ariaScheduleMode);
            scheduleTimeInput.setAttribute('aria-label', t.ariaScheduleTime);
            resultCard.setAttribute('aria-label', t.ariaResults);
            shareBtn.setAttribute('aria-label', t.ariaShare);

            // Update stepper button ARIA labels
            if (steppers[0]) {
                steppers[0].querySelector('.stepper-btn:first-child').setAttribute('aria-label', t.ariaReduceCapacity);
                steppers[0].querySelector('.stepper-btn:last-child').setAttribute('aria-label', t.ariaIncreaseCapacity);
            }
            if (steppers[1]) {
                steppers[1].querySelector('.stepper-btn:first-child').setAttribute('aria-label', t.ariaReducePower);
                steppers[1].querySelector('.stepper-btn:last-child').setAttribute('aria-label', t.ariaIncreasePower);
            }

            // Update preset groups ARIA labels
            if (presetGroups[0]) presetGroups[0].setAttribute('aria-label', t.ariaAcPresets);
            if (presetGroups[1]) presetGroups[1].setAttribute('aria-label', t.ariaDcPresets);

            // Recalculate to update dynamic texts
            calculate();
            saveSettings();
        }

        function initLanguage() {
            const settings = loadSettings();
            const lang = settings.lang || detectBrowserLanguage();
            setLanguage(lang);
        }

        // ==================== DOM Elements ====================
        const currentChargeSlider = document.getElementById('currentCharge');
        const targetChargeSlider = document.getElementById('targetCharge');
        const currentValueDisplay = document.getElementById('currentValue');
        const targetValueDisplay = document.getElementById('targetValue');
        const batteryCapacityInput = document.getElementById('batteryCapacity');
        const chargerPowerInput = document.getElementById('chargerPower');
        const efficiencyInput = document.getElementById('efficiency');
        const efficiencyValue = document.getElementById('efficiencyValue');
        const electricityPriceInput = document.getElementById('electricityPrice');
        const scheduleEnabledInput = document.getElementById('scheduleEnabled');
        const scheduleOptionsEl = document.getElementById('scheduleOptions');
        const scheduleTimeInput = document.getElementById('scheduleTime');
        const modeBtns = document.querySelectorAll('.mode-btn');
        const batteryFill = document.getElementById('batteryFill');
        const batteryTarget = document.getElementById('batteryTarget');
        const resultTime = document.getElementById('resultTime');
        const resultEta = document.getElementById('resultEta');
        const resultEtaLabel = document.getElementById('resultEtaLabel');
        const resultStartRow = document.getElementById('resultStartRow');
        const resultStart = document.getElementById('resultStart');
        const energyNeeded = document.getElementById('energyNeeded');
        const energyFromGrid = document.getElementById('energyFromGrid');
        const chargeCost = document.getElementById('chargeCost');
        const warningMessage = document.getElementById('warningMessage');
        const warningText = document.getElementById('warningText');

        // Cached elements for setLanguage()
        const htmlRoot = document.getElementById('html-root');
        const currentLangFlag = document.getElementById('currentLangFlag');
        const currentLangCode = document.getElementById('currentLangCode');
        const langBtn = document.getElementById('langBtn');
        const langDropdown = document.getElementById('langDropdown');
        const batteryVisual = document.querySelector('.battery-visual');
        const scheduleMode = document.querySelector('.schedule-mode');
        const resultCard = document.querySelector('.result-card');
        const shareBtn = document.getElementById('shareBtn');
        const steppers = document.querySelectorAll('.stepper');
        const presetGroups = document.querySelectorAll('.presets-group');
        const presetButtons = document.querySelectorAll('.preset-btn');
        const langOptions = document.querySelectorAll('.lang-option');
        const translatableElements = document.querySelectorAll('[data-i18n]');

        let currentScheduleMode = 'end';

        // Apply loaded settings to inputs
        function applySettings(settings) {
            currentChargeSlider.value = settings.currentCharge;
            targetChargeSlider.value = settings.targetCharge;
            batteryCapacityInput.value = settings.batteryCapacity;
            chargerPowerInput.value = settings.chargerPower;
            efficiencyInput.value = settings.efficiency;
            electricityPriceInput.value = settings.electricityPrice;
            scheduleEnabledInput.checked = settings.scheduleEnabled;
            scheduleTimeInput.value = settings.scheduleTime;
            currentScheduleMode = settings.scheduleMode || 'end';

            // Update schedule UI
            scheduleOptionsEl.classList.toggle('active', settings.scheduleEnabled);
            modeBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === currentScheduleMode);
            });
        }

        // Settings will be applied during initialization at the end

        // Update battery visual
        function updateBatteryVisual() {
            const current = parseInt(currentChargeSlider.value);
            const target = parseInt(targetChargeSlider.value);

            requestAnimationFrame(() => {
                batteryFill.style.width = current + '%';
                batteryTarget.style.width = target + '%';

                // Update gradient position based on charge level
                const gradientPos = 100 - current;
                batteryFill.style.backgroundPosition = gradientPos + '% 0';
            });
        }

        // Calculate and display results
        function calculate() {
            const currentCharge = parseInt(currentChargeSlider.value);
            const targetCharge = parseInt(targetChargeSlider.value);
            const capacity = Math.max(1, parseFloat(batteryCapacityInput.value) || 50);
            const power = Math.max(0.1, parseFloat(chargerPowerInput.value) || 3.7);
            const efficiency = Math.max(10, Math.min(100, parseFloat(efficiencyInput.value) || 90)) / 100;
            const pricePerKwh = Math.max(0, parseFloat(electricityPriceInput.value) || 0.15);

            // Update displays (batched in rAF for performance)
            const efficiencyPercent = Math.round(efficiency * 100);
            requestAnimationFrame(() => {
                currentValueDisplay.innerHTML = currentCharge + '<span>%</span>';
                targetValueDisplay.innerHTML = targetCharge + '<span>%</span>';
                efficiencyValue.innerHTML = efficiencyPercent + '<span>%</span>';
            });

            // Update battery visual
            updateBatteryVisual();

            // Calculate energy needed
            const chargeNeeded = Math.max(0, targetCharge - currentCharge);
            const energyNeededKwh = (chargeNeeded / 100) * capacity;
            const energyFromGridKwh = energyNeededKwh / efficiency;

            // Calculate time
            const timeHours = energyFromGridKwh / power;
            const hours = Math.floor(timeHours);
            const minutes = Math.round((timeHours - hours) * 60);

            // Format time display
            const t = translations[currentLang];
            if (chargeNeeded === 0) {
                resultTime.innerHTML = '0<span>' + t.minutes + '</span>';
            } else if (hours === 0) {
                resultTime.innerHTML = minutes + '<span>' + t.minutes + '</span>';
            } else if (minutes === 0) {
                resultTime.innerHTML = hours + '<span>' + t.hours + '</span>';
            } else {
                resultTime.innerHTML = hours + '<span>' + t.hours + '</span> ' + minutes + '<span>' + t.minutes + '</span>';
            }

            // Calculate ETA based on schedule mode
            const now = new Date();
            let startTime, endTime;

            if (scheduleEnabledInput.checked && scheduleTimeInput.value) {
                const [schedHours, schedMinutes] = scheduleTimeInput.value.split(':').map(Number);
                const scheduledTime = new Date(now);
                scheduledTime.setHours(schedHours, schedMinutes, 0, 0);

                // If scheduled time is in the past today, assume tomorrow
                if (scheduledTime <= now) {
                    scheduledTime.setDate(scheduledTime.getDate() + 1);
                }

                if (currentScheduleMode === 'start') {
                    // Mode: Start at X ‚Üí calculate end time
                    startTime = scheduledTime;
                    endTime = new Date(startTime.getTime() + timeHours * 60 * 60 * 1000);
                    resultStartRow.style.display = 'none';
                    window.startInPastWarning = null;
                } else {
                    // Mode: Finish at X ‚Üí calculate start time
                    endTime = scheduledTime;
                    startTime = new Date(endTime.getTime() - timeHours * 60 * 60 * 1000);

                    // Check if start time is in the past (impossible to achieve)
                    if (startTime < now) {
                        // Calculate achievable percentage if starting now
                        const availableTimeHours = (endTime.getTime() - now.getTime()) / (60 * 60 * 1000);
                        const achievableEnergy = availableTimeHours * power * efficiency;
                        const achievablePercent = Math.min(100, Math.round(currentCharge + (achievableEnergy / capacity * 100)));

                        // Store for warning display
                        window.startInPastWarning = {
                            target: targetCharge,
                            achievable: achievablePercent
                        };

                        // Adjust startTime to now for display purposes
                        startTime = now;
                    } else {
                        window.startInPastWarning = null;
                    }

                    // Show start time in results
                    const startHours = startTime.getHours().toString().padStart(2, '0');
                    const startMinutes = startTime.getMinutes().toString().padStart(2, '0');
                    const isStartNextDay = startTime.getDate() !== now.getDate();
                    resultStart.textContent = startHours + ':' + startMinutes + (isStartNextDay ? ' (' + t.nextDay + ')' : '');
                    resultStartRow.style.display = 'block';
                }
            } else {
                startTime = now;
                endTime = new Date(startTime.getTime() + timeHours * 60 * 60 * 1000);
                resultStartRow.style.display = 'none';
                window.startInPastWarning = null;
            }

            const etaHours = endTime.getHours().toString().padStart(2, '0');
            const etaMinutes = endTime.getMinutes().toString().padStart(2, '0');

            // Show if it's a different day than today
            const isNextDay = endTime.getDate() !== now.getDate();
            resultEta.textContent = etaHours + ':' + etaMinutes + (isNextDay ? ' (' + t.nextDay + ')' : '');

            // Update details
            energyNeeded.textContent = energyNeededKwh.toFixed(1) + ' kWh';
            energyFromGrid.textContent = energyFromGridKwh.toFixed(1) + ' kWh';
            const totalCost = energyFromGridKwh * pricePerKwh;
            chargeCost.textContent = totalCost.toFixed(2) + ' ‚Ç¨';

            // Warnings
            warningMessage.classList.remove('show');

            if (currentCharge >= targetCharge) {
                warningText.textContent = t.warningAlreadyCharged;
                warningMessage.classList.add('show');
            } else if (window.startInPastWarning && window.startInPastWarning.achievable < window.startInPastWarning.target) {
                // Start time is in the past - show achievable percentage
                warningText.textContent = t.warningStartInPast
                    .replace('{target}', window.startInPastWarning.target)
                    .replace('{achievable}', window.startInPastWarning.achievable);
                warningMessage.classList.add('show');
            } else if (timeHours > THRESHOLDS.LONG_CHARGE_HOURS) {
                warningText.textContent = t.warningLongCharge;
                warningMessage.classList.add('show');
            } else if (power >= THRESHOLDS.DC_POWER_MIN && targetCharge > THRESHOLDS.DC_CURVE_TARGET) {
                // DC fast charging warning: speed drops above 80%
                warningText.textContent = t.warningDcCurve;
                warningMessage.classList.add('show');
            }

            // Update active preset button
            updatePresetButtons();

            // Store current calculation for sharing
            window.lastCalculation = {
                time: hours > 0 ? `${hours}${t.hours} ${minutes}${t.minutes}` : `${minutes}${t.minutes}`,
                from: currentCharge,
                to: targetCharge,
                power: power
            };

            // Save to localStorage
            saveSettings();
        }

        // Debounced calculate for continuous inputs (sliders)
        const calculateDebounced = debounce(calculate, 16);

        // Adjust capacity with stepper buttons
        function adjustCapacity(delta) {
            haptic(10);
            const current = parseFloat(batteryCapacityInput.value) || 50;
            const newValue = Math.max(10, Math.min(200, current + delta));
            batteryCapacityInput.value = newValue;
            calculate();
        }

        // Adjust power with stepper buttons
        function adjustPower(delta) {
            haptic(10);
            const current = parseFloat(chargerPowerInput.value) || 3.7;
            const newValue = Math.max(1, Math.min(350, Math.round((current + delta) * 10) / 10));
            chargerPowerInput.value = newValue;
            calculate();
        }

        // Set power from preset
        function setPower(value) {
            haptic(15);
            chargerPowerInput.value = value;
            calculate();
        }

        // Update preset buttons active state
        function updatePresetButtons() {
            const currentPower = parseFloat(chargerPowerInput.value);

            requestAnimationFrame(() => {
                presetButtons.forEach(btn => {
                    const btnValue = parseFloat(btn.textContent);
                    btn.classList.toggle('active', btnValue === currentPower);
                });
            });
        }

        // Haptic feedback utility
        function haptic(duration = 10) {
            if ('vibrate' in navigator) {
                navigator.vibrate(duration);
            }
        }

        // Event listeners (debounced for continuous slider inputs)
        currentChargeSlider.addEventListener('input', () => { haptic(5); updateBatteryVisual(); calculateDebounced(); });
        targetChargeSlider.addEventListener('input', () => { haptic(5); updateBatteryVisual(); calculateDebounced(); });
        efficiencyInput.addEventListener('input', () => { haptic(5); calculateDebounced(); });

        // Event delegation for stepper buttons
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-adjust]');
            if (btn) {
                const delta = parseFloat(btn.dataset.delta);
                if (btn.dataset.adjust === 'capacity') {
                    adjustCapacity(delta);
                } else if (btn.dataset.adjust === 'power') {
                    adjustPower(delta);
                }
            }
        });

        // Event delegation for preset buttons
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-power]');
            if (btn) {
                setPower(parseFloat(btn.dataset.power));
            }
        });
        // Sanitize on blur (allows user to clear and type new value)
        function sanitizeOnBlur(input, min, max, defaultVal) {
            return function() {
                let val = parseFloat(input.value);
                if (isNaN(val) || val < min) {
                    input.value = defaultVal;
                } else if (val > max) {
                    input.value = max;
                }
                calculate();
            };
        }

        batteryCapacityInput.addEventListener('input', calculate);
        chargerPowerInput.addEventListener('input', calculate);
        electricityPriceInput.addEventListener('input', calculate);

        batteryCapacityInput.addEventListener('blur', sanitizeOnBlur(batteryCapacityInput, 1, 500, 50));
        chargerPowerInput.addEventListener('blur', sanitizeOnBlur(chargerPowerInput, 0.1, 500, 3.7));
        electricityPriceInput.addEventListener('blur', sanitizeOnBlur(electricityPriceInput, 0, 2, 0.15));
        scheduleTimeInput.addEventListener('input', calculate);

        // Schedule toggle
        scheduleEnabledInput.addEventListener('change', () => {
            haptic(15);
            scheduleOptionsEl.classList.toggle('active', scheduleEnabledInput.checked);
            calculate();
        });

        // Schedule mode buttons
        modeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                haptic(15);
                modeBtns.forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-checked', 'false');
                });
                btn.classList.add('active');
                btn.setAttribute('aria-checked', 'true');
                currentScheduleMode = btn.dataset.mode;
                calculate();
            });
        });

        // Prevent target being less than current
        currentChargeSlider.addEventListener('input', () => {
            if (parseInt(currentChargeSlider.value) > parseInt(targetChargeSlider.value)) {
                targetChargeSlider.value = currentChargeSlider.value;
            }
        });

        targetChargeSlider.addEventListener('input', () => {
            if (parseInt(targetChargeSlider.value) < parseInt(currentChargeSlider.value)) {
                currentChargeSlider.value = targetChargeSlider.value;
            }
        });

        // ==================== Language Selector ====================
        const langSelector = document.getElementById('langSelector');
        const langBtnEl = document.getElementById('langBtn');

        langBtnEl.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = langSelector.classList.toggle('open');
            langBtnEl.setAttribute('aria-expanded', isOpen.toString());
        });

        document.querySelectorAll('.lang-option').forEach(option => {
            option.addEventListener('click', () => {
                setLanguage(option.dataset.lang);
                langSelector.classList.remove('open');
                langBtnEl.setAttribute('aria-expanded', 'false');
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            langSelector.classList.remove('open');
            langBtnEl.setAttribute('aria-expanded', 'false');
        });

        // ==================== Web Share API ====================
        const shareBtn = document.getElementById('shareBtn');

        // Show share button only if Web Share API is supported
        if (navigator.share) {
            shareBtn.style.display = 'flex';

            shareBtn.addEventListener('click', async () => {
                const t = translations[currentLang];
                const calc = window.lastCalculation;

                if (!calc) return;

                const text = t.shareText
                    .replace('{time}', calc.time)
                    .replace('{from}', calc.from)
                    .replace('{to}', calc.to)
                    .replace('{power}', calc.power);

                try {
                    await navigator.share({
                        title: t.shareTitle,
                        text: text,
                        url: 'https://alejandrosuch.github.io/watt-wait/'
                    });
                } catch (err) {
                    // User cancelled or share failed - ignore
                    console.log('Share cancelled or failed:', err);
                }
            });
        }

        // ==================== Initialization ====================
        // Apply saved settings first (before language init)
        const savedSettings = loadSettings();
        applySettings(savedSettings);

        // Initialize language (this will also call calculate)
        initLanguage();

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>

    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "f95a63d065674095a5f4e3e76dcff340"}'></script>
</body>
</html>
